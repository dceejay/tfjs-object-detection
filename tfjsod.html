<script type="text/html" data-template-name="tensorflowObjDet">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <div class="form-row">
        <!-- Tabsheets -->
        <ul style="background: #fff; min-width: 600px; margin-bottom: 20px;" id="node-tfjsod-tabs"></ul>
    </div>
    <div id="node-tfjsod-tabs-content" style="min-height: 150px">
        <!-- Content of all tabsheets -->
        <div id="node-tfjsod-tab-general">
            <div class="form-row">
                <label for="node-input-tensorflowConfig"><i class="fa fa-cog"></i> Model</label>
                <!-- Node-Red will replace this input element by a drop-down (with available Tfjs configurations) -->
                <input type="text" id="node-input-tensorflowConfig">
            </div>
            <div class="form-row">
                <label>&nbsp;</label>
                <button id="node-input-generateConfigNodes"><i class="fa fa-plus-circle"></i> Generate default config nodes</button>
            </div>
            <div class="form-row" id="node-inputFormat">
                <label for="node-input-outputFormat"><i class="fa fa-picture-o"></i> Input format</label>
                <select type="text" id="node-input-inputFormat" style="width:70%;">
                    <option value="jpg">JPEG</option>
                    <option value="raw">Raw</option>
                </select>
            </div>
            <div class="form-row">
                <label for="node-input-passthru"><i class="fa fa-picture-o"></i> Passthru</label>
                <select type="text" id="node-input-passthru" style="width:70%;">
                    <option value="none">Nothing</option>
                    <option value="orig">Original Image</option>
                    <option value="bbox">Annotated Image</option>
                </select>
            </div>
            <div class="form-row" id="node-annotation">
                <label for="node-input-annotationExpression"><i class="fa fa-picture-o"></i> Annotation</label>
                <input type="text" id="node-input-annotationExpression">
            </div>
            <div class="form-row" id="node-annotationBackground">
                <label for="node-input-annotationBackground"><i class="fa fa-square"></i> Background</label>
                <select type="text" id="node-input-annotationBackground" style="width:70%;">
                    <option value="none">None</option>
                    <option value="rect">Filled rectangle</option>
                </select>
            </div>
            <div class="form-row" id="node-bbox-padding">
                <label for="node-input-bboxPadding"><i class="fa fa-window-close-o"></i> Padding</label>
                <input type="number" id="node-input-bboxPadding" min="0">
            </div>
            <div class="form-row" id="node-outputFormat">
                <label for="node-input-outputFormat"><i class="fa fa-picture-o"></i> Output format</label>
                <select type="text" id="node-input-outputFormat" style="width:70%;">
                    <option value="jpg">JPEG</option>
                    <option value="raw">Raw</option>
                </select>
            </div>
            <div class="form-row" id="node-bbox-color">
                <label for="node-input-lineColor"><i class="fa fa-paint-brush "></i> Box color</label>
                <input type="color" id="node-input-lineColor" placeholder="HTML5 color or #rrggbb">
            </div>
        </div>
        <div id="node-tfjsod-tab-filters">
            <div class="form-row">
                <label for="node-input-minimumScore"><i class="fa fa-signal"></i> Min. score</label>
                <input type="number" id="node-input-minimumScore" placeholder="e.g. 0 - 1" min="0" max="1" step=".01">
            </div>
            <div class="form-row">
                <label for="node-input-minimumWidth"><i class="fa fa-arrows-h"></i> Min. width</label>
                <input type="number" id="node-input-minimumWidth" min="0">
            </div>
            <div class="form-row">
                <label for="node-input-maximumWidth"><i class="fa fa-arrows-h"></i> Max. width</label>
                <input type="number" id="node-input-maximumWidth" min="0">
            </div>
            <div class="form-row">
                <label for="node-input-minimumHeight"><i class="fa fa-arrows-v"></i> Min. height</label>
                <input type="number" id="node-input-minimumHeight" min="0">
            </div>
            <div class="form-row">
                <label for="node-input-maximumHeight"><i class="fa fa-arrows-v"></i> Max. height</label>
                <input type="number" id="node-input-maximumHeight" min="0">
            </div>
            <div class="form-row">
                <label for="node-input-minimumAspectRatio"><i class="fa fa-arrows"></i> Min. aspect ratio</label>
                <input type="number" id="node-input-minimumAspectRatio" min="0" step=".01">
            </div>
            <div class="form-row">
                <label for="node-input-maximumAspectRatio"><i class="fa fa-arrows"></i> Max. aspect ratio</label>
                <input type="number" id="node-input-maximumAspectRatio" min="0" step=".01">
            </div>
            <div class="form-row">
                <label for="node-input-maximumDetections"><i class="fa fa-level-down "></i> Max. detections</label>
                <input type="number" id="node-input-maximumDetections" min="1">
            </div>
            <div class="form-row">
                <label for="node-input-classFilter"><i class="fa fa-filter"></i> Classes</label>
                <input type="text" id="node-input-classFilter" style="width:70%;">
                <input id="node-input-classFilterType" type="hidden">
            </div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="tensorflowObjDet">
   <p>A <a href="https://www.tensorflow.org/js" target = "_new">TensorFlow.js</a> node to run Tfjs simple object recognition.</p>
   <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">buffer | string</span></dt>
        <dd>A binary buffer of a jpeg image, or string of a filename to load.</dd>
        <dt>minimumScore <span class="property-type">number</span></dt>
        <dd>Minimum score for a valid detection (0 - 1)</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">array</span></dt>
        <dd>an array of detected objects, containing :
        <ul><li><code>bbox</code> array, [x,y,width,height]</li>
            <li><code>class</code> string, detected object class</li>
            <li><code>score</code> number, 0 -> 1.</li>
        </ul></dd>
        <dt>classes <span class="property-type">object</span></dt>
        <dd>an object with each class and their counts, e.g. <code>{dog:3,cat:1}</code>.</dd>
        <dt>shape <span class="property-type">array[3]</span></dt>
        <dd>dimensions of the input image, [x,y,depth].</dd>
        <dt>minimumScore <span class="property-type">number</span></dt>
        <dd>the minimumScore value used in this detection.</dd>
        <dt>image <span class="property-type">buffer</span></dt>
        <dd>(optional) either the original image, or
        the image annotated with detected bounding boxes.</dd>
    </dl>
    <h3>Details</h3>
    <p>The configured minimumScore can be overridden dynamically
        by setting the <code>msg.minimumScore</code> property.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('tensorflowObjDet', {
        category: 'analysis-function',
        defaults: {
            name: { value: "" },
            tensorflowConfig: {value:"", type: "tensorflowObjDetConfig"},
            minimumScore: { value: null },
            minimumHeight: { value: null },
            maximumHeight: { value: null },
            minimumWidth: { value: null },
            maximumWidth: { value: null },
            minimumAspectRatio: { value: null },
            maximumAspectRatio: { value: null },
            maximumDetections: { value: null },
            classFilter: { value: [] },
            inputFormat: { value: "jpg" },
            passthru: { value: "none" },
            annotationExpression: { value: "{{class}}({{scorePercentage}})" },
            annotationBackground: { value: "none" },
            bboxPadding: { value: 0 },
            lineColor: { value: "#FF00FF" }, // Magenta
            outputFormat: { value: "jpg" }
        },
        inputs: 1,
        outputs: 1,
        paletteLabel: "tf object detect",
        color: "#ED782F",
        icon: "tfjs.png",
        label: function() {
            return this.name || "tf object detect";
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            var node = this;

            function createConfigNode(name, options) {
                var id = RED.nodes.id();

                // Create a new config node
                var newConfig = {
                    id: id,
                    _def: RED.nodes.getType("tensorflowObjDetConfig"),
                    type: "tensorflowObjDetConfig",
                    hasUsers: false,
                    users: [],
                    name: name,
                    label: function() { return this.name || name}
                }

                for(var optionName in options) {
                    newConfig[optionName] = options[optionName];
                }

                RED.nodes.add(newConfig);
                return newConfig;
            }
debugger
            $("#node-input-generateConfigNodes").click(function () {
                var defaultConfigNodes = [];

                // The Tfjs model requires much less properties, because the model contains Js code that parses the output automatically
                var labels1 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Coco SSD Tfjs", {
                    runtime: "tfjs",
                    model: "models/coco-ssd/model.json",
                    modelType: "path",
                    labels: '["' + labels1.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json"
                }));

                var labels2 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","n/a","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","n/a","backpack","umbrella","n/a","n/a","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","n/a","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","n/a","dining table","n/a","n/a","toilet","n/a","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","n/a","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Coco SSD TfLite Coral", {
                    runtime: "tflite",
                    model: "models/coco-coral/tf2_ssd_mobilenet_v2_coco17_ptq_edgetpu.tflite",
                    modelType: "path",
                    labels: '["' + labels2.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json",
                    bboxProperty: 1,
                    bboxPropertyType: "index",
                    classProperty: 3,
                    classPropertyType: "index",
                    scoreProperty: 0,
                    scorePropertyType: "index",
                    countProperty: 2,
                    countPropertyType: "index",
                    bboxFormat: "[y1,x1,y2,x2]",
                    resizeAlgorithm: "neirest"
                }));

                var labels3 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Yolo v5 S", {
                    runtime: "graph",
                    model: "models/yolo5s/model.json",
                    modelType: "path",
                    labels: '["' + labels3.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json",
                    bboxProperty: 0,
                    bboxPropertyType: "index",
                    classProperty: 2,
                    classPropertyType: "index",
                    scoreProperty: 1,
                    scorePropertyType: "index",
                    countProperty: 3,
                    countPropertyType: "index",
                    bboxFormat: "[x1,y1,x2,y2]",
                    resizeAlgorithm: "neirest"
                }));

                var labels4 = ["person","bicycle","car","motorcycle","airplane","bus","train","truck","boat","traffic light","fire hydrant","stop sign","parking meter","bench","bird","cat","dog","horse","sheep","cow","elephant","bear","zebra","giraffe","backpack","umbrella","handbag","tie","suitcase","frisbee","skis","snowboard","sports ball","kite","baseball bat","baseball glove","skateboard","surfboard","tennis racket","bottle","wine glass","cup","fork","knife","spoon","bowl","banana","apple","sandwich","orange","broccoli","carrot","hot dog","pizza","donut","cake","chair","couch","potted plant","bed","dining table","toilet","tv","laptop","mouse","remote","keyboard","cell phone","microwave","oven","toaster","sink","refrigerator","book","clock","vase","scissors","teddy bear","hair drier","toothbrush"];
                defaultConfigNodes.push(createConfigNode("Yolo v5 N", {
                    runtime: "graph",
                    model: "models/yolo5n/model.json",
                    modelType: "path",
                    labels: '["' + labels4.join('","') + '"]',
                    labelsType: "json",
                    colors: "[]",
                    colorsType: "json",
                    bboxProperty: 0,
                    bboxPropertyType: "index",
                    classProperty: 2,
                    classPropertyType: "index",
                    scoreProperty: 1,
                    scorePropertyType: "index",
                    countProperty: 3,
                    countPropertyType: "index",
                    bboxFormat: "[x1,y1,x2,y2]",
                    resizeAlgorithm: "neirest"
                }));

                // Add the new config nodes in the dropdown
                defaultConfigNodes.forEach(function (defaultConfigNode, index) {
                    $("#node-input-tensorflowConfig").append($('<option>', {
                        value: defaultConfigNode.id,
                        text: defaultConfigNode.name
                    }));
                });

                // Make sure the "Coco SSD Tfjs" is selected by default.
                // Otherwise they would only be displayed in the list, the next time this config screen is being openened.
                // TODO check why this doesn't work
                $("#node-input-tensorflowConfig").val("Coco SSD Tfjs").change();
            })

            if (this.lineColor === undefined) {
                $("#node-input-lineColor").val("magenta");
            }
            $("#node-input-passthru").change( function() {
                if ($("#node-input-passthru").val() === "bbox") {
                    $("#node-outputFormat").show();
                    $("#node-bbox-color").show();
                    $("#node-annotation").show();
                    $("#node-bbox-padding").show();
                }
                else {
                    $("#node-outputFormat").hide();
                    $("#node-bbox-color").hide();
                    $("#node-annotation").hide();
                    $("#node-bbox-padding").hide();
                }
            });
            
            $("#node-input-classFilter").typedInput({
                default: 'json',
                typeField: $("#node-input-classFilterType"),
                types:['json']
            });
            //$("#node-input-classFilterType").typedInput('type', node.classFilterType);
            // Show tabsheets
            node.tabs = RED.tabs.create({
                id: "node-tfjsod-tabs",
                onchange: function(tab) {
                    // Show only the content (i.e. the children) of the selected tabsheet, and hide the others
                    $("#node-tfjsod-tabs-content").children().hide();
                    $("#" + tab.id).show();
                }
            });
            node.tabs.addTab({
                id: "node-tfjsod-tab-general",
                label: "General"
            });
            node.tabs.addTab({
                id: "node-tfjsod-tab-filters",
                label: "Filters"
            })
            
            // TODO annotation expression field should only be visible if annotated image is output type
        }
    });
</script>
